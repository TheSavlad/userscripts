(()=>{const orderlist=function(){const ozon=window.ozon;const{$,$$,error,log,dom}=ozon;const ORDER_STATE_CANCEL=0;const ORDER_STATE_PREPARING=1;const ORDER_STATE_LOADING=2;const ORDER_STATE_DRIVING=3;const ORDER_STATE_READY=4;const ORDER_STATE_COMPLETE=5;const ORDER_STATE_ENROUTE=6;const GROUP_STATE_CANCEL=0;const GROUP_STATE_COMPLETE=1;const GROUP_STATE_WORKING=2;const GROUP_STATE_READY=3;const stateNeedles="Ð¾Ñ‚Ð¼ÐµÐ½Ñ‘Ð½,Ð² ÑÐ±Ð¾Ñ€ÐºÐµ,Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‘Ñ‚ÑÑ,Ð² Ð¿ÑƒÑ‚Ð¸,Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚,Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½,Ð² ÑÐ»ÑƒÐ¶Ð±Ðµ".split(",");const monthNeedles="ÑÐ½Ð²Ð°Ñ€,Ñ„ÐµÐ²Ñ€Ð°Ð»,Ð¼Ð°Ñ€Ñ‚,Ð°Ð¿Ñ€ÐµÐ»,Ð¼Ð°,Ð¸ÑŽÐ½,Ð¸ÑŽÐ»,Ð°Ð²Ð³ÑƒÑÑ‚,ÑÐµÐ½Ñ‚ÑÐ±Ñ€,Ð¾ÐºÑ‚ÑÐ±Ñ€,Ð½Ð¾ÑÐ±Ñ€,Ð´ÐµÐºÐ°Ð±Ñ€".split(",");const dateRegex=new RegExp(`(\\d+) ((?:${monthNeedles.join("|")})[a-ÑÑ‘]*)`,"i");const stateNames={[ORDER_STATE_CANCEL]:"ðŸ›‘ ÐžÑ‚Ð¼ÐµÐ½Ñ‘Ð½",[ORDER_STATE_PREPARING]:"âŒ› Ð’ ÑÐ±Ð¾Ñ€ÐºÐµ",[ORDER_STATE_LOADING]:"ðŸ“¦ ÐŸÐµÑ€ÐµÐ´Ð°Ñ‘Ñ‚ÑÑ",[ORDER_STATE_ENROUTE]:"ðŸ“¦ Ð’ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐµ",[ORDER_STATE_DRIVING]:"ðŸšš Ð’ Ð¿ÑƒÑ‚Ð¸",[ORDER_STATE_READY]:"âš ï¸ ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚",[ORDER_STATE_COMPLETE]:"âœ… ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½"};const css=[{"body #layoutPage>div>[data-widget=wallpaper]:last-child":{"margin-top":"179px"},"body #layoutPage>div>[data-widget=wallpaper]:first-child>div>header":{"border-bottom-left-radius":"0px","border-bottom-right-radius":"0px"},".ozon-helper-orders":{left:"0px",right:"0px","background-color":"#FFFFFF","border-bottom":"1px solid #E0E6EF",display:"flex","overflow-x":"scroll",gap:"5px",padding:"5px"},".ozon-helper-orders.fixed":{position:"fixed",top:"63px"},".ozon-helper-orders.absolute":{position:"absolute",top:"132px"},".ozon-order":{display:"flex","flex-direction":"column","align-items":"center",border:"1px solid #E0E6EF",padding:"3px"},".ozon-order-ready":{animation:"1s infinite alternate ozon-blink","background-color":"currentcolor","box-shadow":"0px 0px 10px currentcolor"},".ozon-order-ready .ozon-item-state-name":{border:"none",color:"black"},".ozon-order-items":{display:"flex",gap:"3px"},".ozon-item":{display:"flex","flex-direction":"column","align-items":"center",gap:"3px"},".ozon-item-state-name":{"border-bottom":"1px solid #E0E6EF","padding-bottom":"3px"},".ozon-order a":{"min-width":"100px","max-width":"100px","min-height":"100px","max-height":"100px",display:"flex","justify-content":"center","align-items":"center"},".ozon-order a>img":{"max-width":"100%","max-height":"100%"},".ozon-order-divider":{"min-width":"5px","min-height":"100%","background-color":"#E0E6EF"}},"@keyframes ozon-blink {","    0% { background-color: hsl(45, 80%, 50%); box-shadow: 0px 0px 10px hsl(45, 80%, 40%); }","   10% { background-color: hsl(45, 80%, 50%); box-shadow: 0px 0px 10px hsl(45, 80%, 40%); }","   80% { background-color: hsl(45, 80%, 80%); box-shadow: 0px 0px  2px hsl(45, 80%, 40%); }","  100% { background-color: hsl(45, 80%, 80%); box-shadow: 0px 0px  2px hsl(45, 80%, 40%); }","}"];const selectors={header:"",paginator:"",order:"",orderState:""};function getClassName(el){return Object.values(el?.classList||[]).map(x=>`.${x}`).join("")}function findSelectors(){selectors.header='[data-widget="header"]>div:first-child';selectors.paginator='[data-widget="paginator"]>div';const orderList=$("[data-widget=orderList]");if(!orderList)throw new Error("order list not found");const orderImage=$(orderList,"img");if(!orderImage)throw new Error("order image not found");const orderCandidates=Array.from(orderList.firstElementChild?.children??[]);let el=orderImage.parentElement;while(el!==orderList){if(!el)throw new Error("no parent element");if(orderCandidates.includes(el)){selectors.order=getClassName(el.firstElementChild);break}el=el.parentElement}if(!selectors.order)throw new Error("order selector not found");selectors.order=`[data-widget="orderList"] ${selectors.order}`;const order=$(orderList,selectors.order);if(!order)throw new Error("order selector failed");let orderState=$(order,"div>span+svg")?.previousElementSibling;if(!orderState){orderState=$(order,"div>span:first-child:last-child");if(!orderState)throw new Error("order state selector failed")}selectors.orderState=getClassName(orderState);log("selectors =",selectors)}function parseOrderState(row,order){const stateElement=$(row,selectors.orderState);if(!stateElement)return error("state element not found for",row);const stateText=stateElement.innerText.toLowerCase();const orderState=ozon.findMany(stateText,stateNeedles);if(orderState<0)return error("unknown state in",stateElement);order.state=orderState;return true}function parseOrderDate(row,order){let dateElement=null;if(order.state===ORDER_STATE_READY){const svg=$(row,"svg");if(svg){dateElement=svg.previousElementSibling}}if(!dateElement){dateElement=$(row,"p")}if(!dateElement)return error("date element not found for",row);const dateMatch=dateRegex.exec(dateElement.innerText.trim());if(!dateMatch){if(dateElement.innerText.includes("ÑƒÑ‚Ð¾Ñ‡Ð½"))return true;return error("invalid date string in",dateElement)}const[fullMatch,numStr,monStr]=dateMatch;order.date=fullMatch;order.day=+numStr;if(isNaN(order.day))return error("invalid day in",dateElement);order.month=ozon.findMany(monStr.toLowerCase(),monthNeedles);if(order.month<0)return error("unknown month in",dateElement);if(order.state===ORDER_STATE_READY){order.date=`Ð´Ð¾ ${order.date}`}return true}function parseOrderItem(child,order){if(!child)return error("invalid order item element");if(child.tagName!=="A")return error("element not <a>:",child);const el=child;const item={href:"",src:"",state:order.state,stateName:""};item.stateName=stateNames[order.state];item.href=el.href;if(!item.href)return error("no href for",el);const img=$(el,"img");if(!img)return error("no img for",el);item.src=img.src;if(!item.src)return error("no src for",img);return item}function parseOrder(row){const order={day:0,month:0,date:"?",state:-1,items:[]};if(!parseOrderState(row,order))return;if(!parseOrderDate(row,order))return;for(const child of $$(row,"a>img")){const item=parseOrderItem(child.parentElement,order);if(!item)continue;order.items.push(item)}log("order:",order);return order}function parseOrders(paginator){const orders=[];for(const row of $$(paginator,selectors.order)){const order=parseOrder(row);if(!order)continue;orders.push(order)}return orders}function groupOrders(orders){const groups={};for(const order of orders){const items=[];for(const item of order.items){if(item.state===ORDER_STATE_CANCEL)continue;items.push(item)}if(items.length===0)continue;if(!groups[order.date]){groups[order.date]={day:order.day,mon:order.month,str:order.date,state:-1,index:+[1,String(order.month).padStart(2,"0"),String(order.day).padStart(2,"0")].join(""),orders:[]}}groups[order.date].orders.push(...items)}for(const group of Object.values(groups)){group.state=GROUP_STATE_WORKING;if(group.orders.some(x=>x.state===ORDER_STATE_READY))group.state=GROUP_STATE_READY;else if(group.orders.every(x=>x.state===ORDER_STATE_COMPLETE))group.state=GROUP_STATE_COMPLETE;else if(group.orders.every(x=>x.state===ORDER_STATE_CANCEL))group.state=GROUP_STATE_CANCEL}return Object.values(groups).sort(ozon.desc("state"))}function categorizeGroups(groups){const ready=[];const working=[];const complete=[];for(const group of groups){if(group.state===GROUP_STATE_CANCEL)continue;const category={[GROUP_STATE_COMPLETE]:complete,[GROUP_STATE_WORKING]:working,[GROUP_STATE_READY]:ready}[group.state];if(!category){error("unknown group category for:",group);continue}category.push(group)}return[complete,working,ready]}function addOrderGroupDivider(target){target.appendChild(dom("div",{className:"ozon-order-divider"}))}function showOrderGroup(group,target){const classes=["ozon-order"];if(group.state===GROUP_STATE_READY)classes.push("ozon-order-ready");const el=dom("div",{className:classes.join(" ")},dom("div",{className:"ozon-order-items"},group.orders.map(x=>dom("div",{className:"ozon-item"},dom("a",{href:x.href},dom("img",{loading:"lazy",fetchPriority:"low",src:x.src})),dom("div",{className:"ozon-item-state"},dom("div",{className:"ozon-item-state-name"},x.stateName))))),dom("div",{className:"ozon-order-date"},group.str));el.dataset.state=group.state;target.appendChild(el)}function showCategory(target,category,sorting){category.sort(sorting("index")).forEach(x=>showOrderGroup(x,target))}function onPaginator(paginator,container){log("updating orders");const orders=parseOrders(paginator);log(orders.length,"orders found");const groups=groupOrders(orders);log("groups:",groups);const[complete,working,ready]=categorizeGroups(groups);while(container.firstChild)container.firstChild.remove();const len1=ready.length;const len2=working.length;const len3=complete.length;const len12=len1+len2;const len23=len2+len3;showCategory(container,ready,ozon.asc);if(len1>0&&len23>0)addOrderGroupDivider(container);showCategory(container,working,ozon.asc);if(len12>0&&len3>0)addOrderGroupDivider(container);showCategory(container,complete,ozon.desc)}function onHeader(header,container){log("updating header");const isSticky=header.classList.length>1;log("header is sticky =",isSticky);container.classList.toggle("fixed",isSticky);container.classList.toggle("absolute",!isSticky)}return function(){ozon.css(...css);findSelectors();const header=$(selectors.header);if(!header)return error("sticky header not found");log("stickyHeader =",header);const list=$("[data-widget=paginator]>div");if(!list)return error("paginator not found");log("paginator =",list);const orders=dom("div",{className:"ozon-helper-orders"});orders.addEventListener("wheel",e=>{orders.scrollBy({left:e.deltaY,behavior:"smooth"});e.preventDefault()});document.body.appendChild(orders);log("container created:",orders);ozon.observe(header,{attributes:true},()=>onHeader(header,orders));log("observing header");onHeader(header,orders);ozon.observe(list,{childList:true},()=>onPaginator(list,orders));log("observing paginator");onPaginator(list,orders)}}();window.ozon.orderlist=orderlist})();
